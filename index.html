<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CSV â†’ XÉ™ritÉ™ (Waze Naviqasiya)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }

    #topbar{
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      border-bottom: 1px solid #e6e6e6;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #brand{ font-weight: 800; white-space: nowrap; }

    #searchInput{
      flex: 1 1 260px;
      max-width: 520px;
      min-width: 220px;
      padding: 9px 10px;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }

    #fileWrap{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    button{
      padding: 9px 10px;
      border: 1px solid #dcdcdc;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      white-space: nowrap;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid #e2e2e2;
      border-radius: 999px;
      font-size: 12.5px;
      white-space: nowrap;
      margin-left: auto;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
    }

    #map { height: calc(100% - 62px); }

    .popup{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.3;
    }
    .popup .title{ font-weight: 700; margin-bottom: 6px; }
    .muted{ color: #666; }

    .waze-btn{
      display: block;
      margin-top: 8px;
      padding: 10px 12px;
      text-align: center;
      background: #33ccff;
      color: #003344;
      font-weight: 700;
      border-radius: 10px;
      text-decoration: none;
    }
  </style>
</head>

<body>

<div id="topbar">
  <div id="brand">CSV â†’ XÉ™ritÉ™</div>

  <input
    id="searchInput"
    type="text"
    placeholder="Axtar: District vÉ™ ya SubRetailer Draw ID..."
  />

  <div id="fileWrap">
    <input id="fileInput" type="file" accept=".csv,text/csv" />
    <button id="clearBtn">TÉ™mizlÉ™</button>
  </div>

  <div class="pill">
    <span class="dot"></span>
    <span id="statusText">0 marker</span>
  </div>
</div>

<div id="map"></div>

<script>
  const map = L.map('map').setView([40.4093, 49.8671], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);

  let allPoints = [];

  const searchInput = document.getElementById('searchInput');
  const statusText = document.getElementById('statusText');

  function safe(v){ return (v ?? '').toString().trim(); }
  function toNum(v){
    const n = Number(safe(v).replace(',', '.'));
    return Number.isFinite(n) ? n : null;
  }

  const standardMarkerIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });

  function popupHtml(p){
    const wazeUrl = `https://waze.com/ul?ll=${p.lat},${p.lng}&navigate=yes`;
    return `
      <div class="popup">
        <div class="title">${p.district}</div>
        ${p.id ? `<div><span class="muted">ID:</span> ${p.id}</div>` : ''}
        <a class="waze-btn" href="${wazeUrl}" target="_blank" rel="noopener">
          ðŸš— Waze ilÉ™ get
        </a>
      </div>`;
  }

  function render(points){
    markersLayer.clearLayers();

    points.forEach(p=>{
      const m = L.marker([p.lat, p.lng], { icon: standardMarkerIcon })
        .bindPopup(popupHtml(p))
        .addTo(markersLayer);

      p._marker = m;
    });

    statusText.textContent = `${points.length} / ${allPoints.length} marker`;

    if (points.length){
      map.fitBounds(points.map(p => [p.lat, p.lng]), { padding: [40, 40] });
    }
  }

  function applySearch(){
    const q = safe(searchInput.value).toLowerCase();
    if (!q) return render(allPoints);

    const filtered = allPoints.filter(p =>
      p.districtKey.includes(q) || p.idKey.includes(q)
    );

    render(filtered);

    if (filtered.length === 1 && filtered[0]._marker) {
      filtered[0]._marker.openPopup();
    }
  }

  function loadCSV(text){
    Papa.parse(text,{
      header:true,
      skipEmptyLines:true,
      complete:r=>{
        allPoints = r.data.map(row=>{
          const lat = toNum(row['Latitude']);
          const lng = toNum(row['Longitude']);
          if (lat === null || lng === null) return null;

          const d = safe(row['District']) || 'Unknown';
          const id = safe(row['SubRetailer Draw ID']);

          return {
            district: d,
            districtKey: d.toLowerCase(),
            id,
            idKey: id.toLowerCase(),
            lat, lng
          };
        }).filter(Boolean);

        render(allPoints);
      }
    });
  }

  document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const r = new FileReader();
    r.onload = () => loadCSV(r.result);
    r.readAsText(file);
  });

  document.getElementById('clearBtn').onclick = () => {
    markersLayer.clearLayers();
    allPoints = [];
    searchInput.value = '';
    statusText.textContent = '0 marker';
    map.setView([40.4093, 49.8671], 8);
  };

  let t = null;
  searchInput.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(applySearch, 120);
  });
</script>

</body>
</html>
